<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tobar Inversiones | Dashboard</title>
    
    <!-- LibrerÃ­as de Interfaz -->
    <script src="https://cdn.jsdelivr.net"></script>
    <script src="https://cdnjs.cloudflare.com"></script>

    <style>
        :root { --p: #27ae60; --s: #2c3e50; --bg: #0b0f1a; --card: #161c2d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; }
        .app-container { max-width: 500px; margin: auto; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #2d3748; }
        .balance-amount { font-size: 2.2em; font-weight: bold; color: var(--p); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-buy { background: var(--p); color: white; }
        .btn-connect { background: #3182ce; color: white; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 1px solid #2d3748; border-radius: 10px; margin: 10px 0; background: #0b0f1a; color: white; box-sizing: border-box; }
        .roadmap-item { border-left: 2px solid var(--p); padding-left: 15px; margin-bottom: 10px; font-size: 0.85em; color: #a0aec0; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- BOTÃ“N DE CONEXIÃ“N WALLETCONNECT -->
    <div id="connect-root"></div>
    <button class="btn btn-connect" id="btn-connect">CONECTAR WALLET</button>

    <div class="card">
        <div style="opacity: 0.7;">Valor de tu InversiÃ³n</div>
        <div class="balance-amount" id="userValue">$0.00</div>
        <span style="color: var(--p);">+12.5% Este mes</span>
    </div>

    <div class="card">
        <canvas id="mainChart" height="180"></canvas>
    </div>

    <div class="card">
        <h3>Operar Acciones</h3>
        <input type="number" id="amountInput" placeholder="Cantidad">
        <button class="btn btn-buy" onclick="operar('comprar')">COMPRAR</button>
        <button class="btn" style="background:transparent; border:1px solid #4a5568; color:white;" onclick="operar('vender')">VENDER AL BROKER</button>
    </div>

    <div class="card">
        <h3>ðŸš€ Roadmap 2024</h3>
        <div class="roadmap-item"><strong>Q3:</strong> Staking de Acciones con interÃ©s compuesto.</div>
        <div class="roadmap-item"><strong>Q4:</strong> Listado en Exchanges Descentralizados.</div>
        <div class="roadmap-item" style="opacity:0.5;"><strong>2025:</strong> Tarjeta de DÃ©bito Tobar Corp.</div>
    </div>
</div>

<!-- LÃ³gica de WalletConnect y Contrato -->
<script type="module">
    import { createAppKit } from 'https://esm.sh'
    import { Ethers5Adapter } from 'https://esm.sh-adapter-ethers5'
    import { sepolia } from 'https://esm.sh/networks'

    // CONFIGURACIÃ“N (Rellena tus datos)
    const projectId = 'ed489f349c2d732a043fb4ee61405800'; 
    const BROKER_ADDR = "0x501870Af2320fC83EC0DD30048eBB5b598B5e1Ed";
    const BROKER_ABI = [
        "function comprarAcciones(uint256 cantidad)",
        "function venderAlBroker(uint256 cantidad)",
        "function precioRecompra() view returns (uint256)"
    ];

    // 1. Inicializar AppKit (WalletConnect)
    const modal = createAppKit({
        adapters: [new Ethers5Adapter()],
        networks: [sepolia],
        metadata: { name: 'Tobar Corp Inversiones', url: window.location.origin, icons: [] },
        projectId
    })

    document.getElementById('btn-connect').onclick = () => modal.open();

    // 2. FunciÃ³n de OperaciÃ³n
    window.operar = async (tipo) => {
        const cantidad = document.getElementById('amountInput').value;
        if (!cantidad) return alert("Ingresa cantidad");

        try {
            const walletProvider = modal.getWalletProvider();
            if (!walletProvider) return modal.open();

            const provider = new ethers.providers.Web3Provider(walletProvider);
            const signer = provider.getSigner();
            const contrato = new ethers.Contract(BROKER_ADDR, BROKER_ABI, signer);

            const montoWei = ethers.utils.parseEther(cantidad);
            let tx;

            if (tipo === 'comprar') {
                tx = await contrato.comprarAcciones(montoWei);
            } else {
                tx = await contrato.venderAlBroker(montoWei);
            }

            alert("Firma enviada. Revisa tu billetera.");
            await tx.wait();
            alert("âœ… Ã‰xito");
            location.reload();
        } catch (e) {
            alert("Error: " + (e.reason || e.message));
        }
    }

    // 3. GrÃ¡fico
    const ctx = document.getElementById('mainChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Ene', 'Feb', 'Mar', 'Abr'],
            datasets: [{ data: [100, 120, 115, 140], borderColor: '#27ae60', tension: 0.4, fill: true, backgroundColor: 'rgba(39,174,96,0.1)' }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });
</script>

</body>
</html>
