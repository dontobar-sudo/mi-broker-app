<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tobar Inversiones | Fix</title>
    
    <!-- LIBRERÍAS DESDE UN SOLO DOMINIO SEGURO (CLOUDFLARE) -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
    <!-- Web3Modal (Cambiadas a unpkg para evitar el bloqueo de jsdelivr) -->
    <script src="https://unpkg.com"></script>
    <script src="https://unpkg.com"></script>

    <style>
        :root { --p: #27ae60; --bg: #0b0f1a; --card: #161c2d; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; text-align: center; }
        .app-container { max-width: 450px; margin: auto; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #2d3748; }
        .balance-amount { font-size: 2.2em; font-weight: bold; color: var(--p); margin: 10px 0; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-connect { background: #3182ce; color: white; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border-radius: 10px; margin: 10px 0; background: #0b0f1a; color: white; border: 1px solid #2d3748; text-align: center; }
    </style>
</head>
<body>

<div class="app-container">
    <button class="btn btn-connect" id="btnConnect">CONECTAR BILLETERA</button>

    <div class="card">
        <div style="opacity: 0.7;">Valor de tu Inversión</div>
        <div class="balance-amount" id="userValue">$0.00</div>
        <div id="tokenBalance" style="font-size: 0.8em; color: #4a5568;">Acciones: 0.00 TCT</div>
    </div>

    <div class="card"><canvas id="mainChart"></canvas></div>

    <div class="card">
        <h3>Operar</h3>
        <input type="number" id="amountInput" placeholder="Cantidad TCT">
        <button class="btn" style="background:var(--p); color:white;" onclick="operar('comprar')">COMPRAR</button>
        <button class="btn" style="background:transparent; border:1px solid #4a5568; color:white;" onclick="operar('vender')">VENDER</button>
    </div>
</div>

<script>
    // Esperar a que todo cargue para evitar "Undefined"
    window.onload = function() {
        const projectId = 'ed489f349c2d732a043fb4ee61405800'; 
        const BROKER_ADDR = "0x501870Af2320fC83EC0DD30048eBB5b598B5e1Ed";
        const TOKEN_ADDR = "0x8B066E93aB5Da75B7F8131570fc94b61ebd04e52";

        // Verificar si las librerías cargaron
        if (typeof Web3ModalEthereum === 'undefined') {
            console.error("Librerías bloqueadas por el navegador.");
            document.getElementById('btnConnect').innerText = "ERROR DE CARGA";
            return;
        }

        const { EthereumClient, w3mConnectors, w3mProvider } = Web3ModalEthereum;
        const { Web3Modal } = Web3ModalHtml;

        const chains = [{ chainId: 11155111, name: 'Sepolia' }];
        const wagmiConfig = WagmiCore.createConfig({
            autoConnect: true,
            connectors: w3mConnectors({ projectId, chains }),
            publicClient: w3mProvider({ projectId })
        });

        const ethClient = new EthereumClient(wagmiConfig, chains);
        const modal = new Web3Modal({ projectId }, ethClient);

        window.operar = async (tipo) => {
            const cant = document.getElementById('amountInput').value;
            const account = WagmiCore.getAccount();
            if (!account.isConnected) return modal.openModal();

            try {
                const provider = new ethers.providers.Web3Provider(await account.connector.getProvider());
                const signer = provider.getSigner();
                const contract = new ethers.Contract(BROKER_ADDR, ["function comprarAcciones(uint256)", "function venderAlBroker(uint256)"], signer);
                const tx = (tipo === 'comprar') ? await contract.comprarAcciones(ethers.utils.parseEther(cant)) : await contract.venderAlBroker(ethers.utils.parseEther(cant));
                alert("¡Transacción enviada!");
                await tx.wait();
                location.reload();
            } catch (e) { alert("Error: " + e.message); }
        };

        document.getElementById('btnConnect').onclick = () => modal.openModal();

        // Gráfico
        const ctx = document.getElementById('mainChart');
        if (typeof Chart !== 'undefined') {
            new Chart(ctx, {
                type: 'line',
                data: { labels: ['S1','S2','S3','S4'], datasets: [{ data: [1, 1.2, 1.1, 1.4], borderColor: '#27ae60', tension: 0.4 }] },
                options: { plugins: { legend: { display: false } } }
            });
        }
    };
</script>
</body>
</html>
